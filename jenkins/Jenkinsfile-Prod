pipeline {
	agent any
	
	options {
		buildDiscarder logRotator(artifactDaysToKeepStr: '', artifactNumToKeepStr: '', daysToKeepStr: '', numToKeepStr: '20')
	}
	
	parameters({
		credentials(name: 'IBM_CLOUD_CREDENTIALS', credentialType: 'com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl', defaultValue: '', description: 'IBM Cloud credentials to login via cf cli', required: true)

		string(name: 'SITE_GIT_URL', defaultValue: 'git@github.ibm.com:ICP4APPs/code-conjuring.git', description: 'Git url to clone for the site repository')
		string(name: 'SITE_GIT_REVISION', defaultValue: 'master', description: 'Branch to clone for the site repository')

		string(name: 'DOCS_GIT_URL', defaultValue: 'git@github.ibm.com:ICP4APPs/docs.git', description: 'Git url to clone for the docs repository')
		string(name: 'DOCS_GIT_REVISION', defaultValue: 'master', description: 'Branch to clone for the docs repository')

		string(name: 'BLOGS_GIT_URL', defaultValue: 'git@github.ibm.com:ICP4APPs/blogs.git', description: 'Git url to clone for the blogs repository')
		string(name: 'BLOGS_GIT_REVISION', defaultValue: 'master', description: 'Branch to clone for the docs repository')

		booleanParam(name: 'REBUILD_DOCKER_IMAGE', defaultValue: false, description: 'Rebuild the dockerfile.build docker image')
	})

	stages {
		stage ('Clean Workspace') {
			steps {
				cleanWs()
			}
		}
		
		stage ('Checkout site Repository') {
			steps {
 				checkout changelog: false, poll: false, scm: [$class: 'GitSCM', branches: [[name: "${SITE_GIT_REVISION}"]],
					doGenerateSubmoduleConfigurations: false, extensions: [[$class: 'RelativeTargetDirectory']],
					submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'kabanero-github', url: "${SITE_GIT_URL}"]]]
			}
		}
		
		stage ('Checkout Docs Repository') {
			steps {
 				checkout changelog: false, poll: false, scm: [$class: 'GitSCM', branches: [[name: "${DOCS_GIT_REVISION}"]],
					doGenerateSubmoduleConfigurations: false, extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'src/main/content/docs']],
					submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'kabanero-github', url: "${DOCS_GIT_URL}"]]]
			}
		}
		
		stage ('Checkout Blogs Repository') {
			steps {
 				checkout changelog: false, poll: false, scm: [$class: 'GitSCM', branches: [[name: "${BLOGS_GIT_REVISION}"]],
					doGenerateSubmoduleConfigurations: false, extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'blogs']],
					submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'kabanero-github', url: "${BLOGS_GIT_URL}"]]]
				
				// blogs repository needs certain parts in different dirs
				sh 'rsync -av blogs/ src/main/content/ && rm -rf blogs'
			}
		}

		stage ('Rebuild Docker Image') {
			when {
				expression {
					return params.REBUILD_DOCKER_IMAGE
				}
			}
			steps {
				script {
					sh 'docker build -f Dockerfile.build -t codeconjuring .'
				}
			}
		}

		stage ('Build site') {
			steps {
				withDockerContainer(image: "codeconjuring", args: "-e JEKYLL_ENV=production") {
					sh '"${WORKSPACE}"/jenkins/build.sh'
				}
			}
		}
		
		stage ('Deploy site to Cloud Foundry') {
			steps {
				withCredentials([usernamePassword(credentialsId: '${IBM_CLOUD_CREDENTIALS}', passwordVariable: "IBM_CLOUD_PASSWORD", usernameVariable: "IBM_CLOUD_USER")]) {
					withDockerContainer(image: "codeconjuring", args: "-u root -e IBM_CLOUD_API=api.ng.bluemix.net -e IBM_CLOUD_SPACE=kabanero -e IBM_CLOUD_ORGANIZATION=WAS_Cloud1") {
						sh '"${WORKSPACE}"/.travis/cf-push.sh kabanero-prod'
					}
				}
			}
		}
	}
}
